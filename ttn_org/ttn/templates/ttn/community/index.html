{% extends "ttn/community/base.html" %}
{% load staticfiles markup jsonify %}

{% block menu %}
{% endblock %}

{% block author %}
                {% for leader in community.leaders.all %}
                <div class="leader">
                    <img class="inititator" src="{% if leader.ttnuser.image_thumb_url %}{{ leader.ttnuser.image_thumb_url }}{% else %}{% static 'ttn/media/team/newmember.png' %}{% endif %}">
                    <h2 class="initiator-name">{{ leader.first_name }} {{ leader.last_name }}</h2>
                    <h3 class="initiator-city">{% if leader.tagline %}{{ leader.tagline }}{% else %}Initiator for {{ community.title }}{% endif %}</h3>
                </div>
                {% endfor %}
{% endblock %}

{% block extra_js %}
<script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
<script src="{% static 'ttn/js/map.js' %}"></script>
<script>
      function initialize() {
        var mapCanvas = document.getElementById('map-inline');
        var mapOptions = {
          center: new google.maps.LatLng(
                {{ community.lat|default:'44.5403' }},
                {{ community.lon|default:'-78.5463' }}),
          zoom: {{ community.scale|default:13 }},
          scrollwheel: false,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        }
        var map = new google.maps.Map(mapCanvas, mapOptions)

        var gatewaydump = {{ community.gateways.all|jsonify }};
        var gateways = draw_gateways(map, gatewaydump);
      }
      google.maps.event.addDomListener(window, 'load', initialize);
</script>
{% endblock %}


{% block content %}
            <article class="intro">

                {% if 'admin' in permissions %}
                <a class="box" href="{% url 'ttn:community-settings' slug=community.slug %}">UPDATE THIS PAGE</a>
                <div>&nbsp;</div>
                {% endif %}

                <h1>We are on a mission to build a global open crowdsourced Internet of Things data network.</h1>

                <div class="intro-mission">
                    {% if community.mission %}
                        {{ community.mission|markdown }}
                    {% else %}
                        <p>{{ community.leaders.first.first_name }} {{ community.leaders.first.last_name }} has taken the job upon him to rollout The Things Network in {{ community.title }}.</p>
                    {% endif %}
                </div>

                {% if community.description %}
                <div class="page-content">
                    {{ community.description|markdown }}
                </div>
                {% endif %}
            </article>
            
            <article class="coverage-progress">
                <!-- div class="progress">
                    <h1>Progress</h1>
                    <img src="{% static 'ttn/media/progress.png' %}">
                </div -->
                <div>
                    <a class="btn-big box" href="{% url 'ttn:kickstarter' %}" target="_blank">
                        Place a gateway Now
                    </a>
                </div>

                <div class="clear"></div>
                <a name="map">&nbsp;</a>
                <div id="map-inline">Loading map..</div>
            </article>
            
        <article class="how-to-connect">
            <h1>Stay up to date</h1>
                <section class="article-text"><p>Want to know more about The Things Network? Sign up for our newsletter and receive all the important news.</p></section>
                <!-- Begin MailChimp Signup Form -->
                <div id="mc_embed_signup">
                    <form action="//thethingsnetwork.us11.list-manage.com/subscribe/post?u=20406705fec6d7d4b2ab1d6cc&amp;id=0b4108dfeb" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
                        <div id="mc_embed_signup_scroll">
                            <div class="mc-field-group">
                                <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Fill in your email address">
                                <input type="hidden" value="{{ community.slug }}" name="CAMPAIGN" id="mce-CAMPAIGN">
                            </div>
	                       <div id="mce-responses" class="clear">
                                <div class="response" id="mce-error-response" style="display:none"></div>
                                <div class="response" id="mce-success-response" style="display:none"></div>
                               </div>
                            </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                            <div style="position: absolute; left: -5000px;"><input type="text" name="b_20406705fec6d7d4b2ab1d6cc_0b4108dfeb" tabindex="-1" value=""></div>
                            <div class="clear">
                            <br>
                                <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
                            </div>
                        </div>
                    </form>
                </div>
<!--End mc_embed_signup-->
        </article>    
            
            <article class="information">
                <section class="left-bar">
                    <h1>Contributors</h1>
                    {% for member in community.members.all|slice:":4" %}
                    <img class="user-img" alt="{{ member.first_name }} {{ member.last_name }}" title="{{ member.first_name }} {{ member.last_name }}"
                     src="{% if member.ttnuser.image_thumb_url %}{{ member.ttnuser.image_thumb_url }}{% else %}{% static 'ttn/media/team/newmember.png' %}{% endif %}">
                    {% endfor %}

                    {% if community.members.all|length > 4 %}
                    <button id="usersButton" class="btn btn-lg button" data-toggle="modal" data-target="#usersModal" type="button">See all</button>
                    {% endif %}

                    <div class="bottom-button">
                        <p><a class="box" href="{% url 'ttn:community-contact' slug=community.slug %}">
                            Contact us
                        </a></p>
                    </div>
                </section>
            
                <section class="center">
                    <div class="blog-posts">
                        <h1>Posts</h1>
                            {% if community.post_set.all %}
                            {% for post in community.post_set.all|slice:":2" %}
                            <div class="blog-post">
                                <div class="blog-image" style="background-image: url('{% if post.image_url %}{{ post.image_url }}{% endif %}');"></div>
                                
                                <div class="blog-text">
                                    <div class="right-info">
                                        {{ post.created }}
                                    </div>
                                    <h4>{{ post.title }}</h4>
                                    <p class="title-author">
                                        By {{ post.author.first_name }} {{ post.author.last_name }}
                                    </p>
                                    <p>{{ post.description|markdown|truncatewords_html:40 }}</p>
                                    <a class="box" href="{% url 'ttn:community-post' slug=community.slug pk=post.pk %}">
                                        Read more
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="blog-post">
                                <p>The {{ community.title }} community hasn't posted anything yet!</p>
                            </div>
                            {% endif %}

                            <div class="bottom-button">
                                {% if community.post_set.all|length > 2 %}
                                <a class="box" href="{% url 'ttn:community-posts' slug=community.slug %}">
                                    See archive
                                </a>
                                {% endif %}
                                {% if 'admin' in permissions %}
                                <a class="box" href="{% url 'ttn:community-post-edit' slug=community.slug pk='new' %}">
                                    Add update
                                </a>
                                {% endif %}
                            </div>
                    </div>
                </section>
            
                <section class="right-bar">
                    <div class="half-bar">
                        <h1>Media</h1>
                        {% if community.media_set.all %}
                        {% for medium in community.media_set.all|slice:":2" %}
                        <div class="side-post">
                            <h4>{{ medium.title }}</h4>
                            <a href="{{ medium.url }}" target="_blank">read more</a>
                        </div>
                        {% endfor %}
                        {% if community.media_set.all|length > 2 %}
                        <button id="mediaButton" class="btn btn-lg button" data-toggle="modal" data-target="#mediaModal" type="button">See all</button>
                        {% endif %}

                        {% else %}
                        <div class="side-post">
                            The {{ community.title }} community is working on media attention!
                        </div>
                        {% endif %}

                    </div>

                    <div class="vseperator">&nbsp;</div>

                    <div class="half-bar">
                        <h1>Resources</h1>
                        {% if community.meetup_url %}
                        <div class="side-post">
                            <h4>Meetup group</h4>
                            <a href="{{ community.meetup_url_full }}" target="_blank">go to meetup.com</a>
                        </div>
                        {% endif %}

                        {% if community.twitter_handle %}
                        <div class="side-post">
                            <h4>Twitter feed</h4>
                            <a href="{{ community.twitter_url_full }}" target="_blank">go to twitter</a>
                        </div>
                        {% endif %}

                        {% if community.resource_set.all %}
                        {% for resource in community.resource_set.all|slice:":2" %}
                        <div class="side-post">
                            <h4>{{ resource.title }}</h4>
                            <a href="{{ resource.url }}" target="_blank">have a look</a>
                        </div>
                        {% endfor %}
                        {% if community.resource_set.all|length > 2 %}
                        <button id="resourcesButton" class="btn btn-lg button" data-toggle="modal" data-target="#resourcesModal" type="button">See all</button>
                        {% endif %}

                        {% else %}
                        <div class="side-post">
                            We don't have any external resources yet.
                        </div>
                        {% endif %}

                    </div>
                </section>
         </article>

        {% if community.companies.all %}
         <article class="our-contributors">
             <div class="container">
                 <!-- h2>Friends</h2 -->
                 {% for company in community.companies.all %}
                 <a href="{{ company.url }}" target="_blank">
                    <div class="company-logo" style="background-image:url('{{ company.image_logo_url }}');"></div>
                 </a>
                 {% endfor %}
             </div>
         </article>
        {% endif %}


        <!-- Modals -->
        {% with users=community.members.all title='Contributors to '|add:community.title %}
        {% include 'ttn/partials/users_modal.html' %}
        {% endwith %}

        {% with media=community.media_set.all title='Media attention for '|add:community.title %}
        {% include 'ttn/partials/media_modal.html' %}
        {% endwith %}

        {% with resources=community.resource_set.all title='Resources of '|add:community.title %}
        {% include 'ttn/partials/resources_modal.html' %}
        {% endwith %}
        <!-- End Modals -->

{% endblock %}
